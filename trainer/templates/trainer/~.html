{% extends '../base.html' %}
{% block content %}
<div class="container card-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-2">HSK Карточки</h1>
            <p class="text-muted">Управляйте своим словарём китайских иероглифов</p>
        </div>
    </div>

    <!-- Таблица карточек -->
    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 15%;">Иероглиф</th>
                    <th style="width: 15%;">Пиньинь</th>
                    <th style="width: 40%;">Перевод</th>
                    <th style="width: 30%;">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for card in cards %}
                    <tr>
                        <!-- Иероглиф -->
                        <td>
                            <div style="font-size: 1.8rem; font-weight: bold; color: #dc3545; font-family: 'SimHei', 'Microsoft YaHei', sans-serif;">
                                {{ card.hieroglyph }}
                            </div>
                        </td>

                        <!-- Пиньинь -->
                        <td>
                            <small class="text-muted">{{ card.transcription }}</small>
                        </td>

                        <!-- Перевод -->
                        <td>
                            <span>{{ card.translate }}</span>
                        </td>

                        <!-- Действия -->
                        <td>
                            <div class="btn-group" role="group">
                                <!-- Кнопка воспроизведения аудио -->
                                {% if card.audio %}
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="playAudio('{{ card.audio.url }}')"
                                            title="Слушать произношение">
                                        <i class="bi bi-play-circle"></i> Слушать
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary" disabled title="Аудио недоступно">
                                        <i class="bi bi-mic-mute"></i> Нет аудио
                                    </button>
                                {% endif %}

                                <!-- Кнопка просмотра -->
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#cardModal{{ card.id }}"
                                        title="Просмотреть детали">
                                    <i class="bi bi-eye"></i> Просмотр
                                </button>

                                <!-- Кнопка добавления в словарь -->
                                <button class="btn btn-sm btn-outline-success add-to-dictionary" 
                                        data-card-id="{{ card.id }}"
                                        title="Добавить в мой словарь">
                                    <i class="bi bi-bookmark-plus"></i> Словарь
                                </button>
                            </div>
                        </td>
                    </tr>

                    <!-- Модальное окно для просмотра подробностей -->
                    <div class="modal fade" id="cardModal{{ card.id }}" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header border-0">
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center py-4">
                                    <div style="font-size: 4rem; font-weight: bold; color: #dc3545; margin-bottom: 1rem; font-family: 'SimHei', 'Microsoft YaHei', sans-serif;">
                                        {{ card.hieroglyph }}
                                    </div>
                                    <div class="mb-3">
                                        <h5 class="text-muted mb-2">Пиньинь</h5>
                                        <p style="font-size: 1.2rem;">{{ card.transcription }}</p>
                                    </div>
                                    <div class="mb-3">
                                        <h5 class="text-muted mb-2">Перевод</h5>
                                        <p style="font-size: 1.1rem;">{{ card.translate }}</p>
                                    </div>
                                    {% if card.audio %}
                                        <button class="btn btn-danger" onclick="playAudio('{{ card.audio.url }}')">
                                            <i class="bi bi-play-fill"></i> Прослушать
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="modal-footer border-0">
                                    <button type="button" class="btn btn-outline-success add-to-dictionary" data-card-id="{{ card.id }}" data-bs-dismiss="modal">
                                        <i class="bi bi-bookmark-plus"></i> Добавить в словарь
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle"></i> Карточки не найдены. Добавьте новые карточки.
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .table {
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .table thead {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
        transition: background-color 0.15s ease;
    }

    .btn-group .btn {
        border-color: #dee2e6;
    }

    .btn-group .btn:hover {
        transition: all 0.15s ease;
    }

    .modal-content {
        border-radius: 12px;
        border: 1px solid #dee2e6;
    }
</style>

<script>
    function playAudio(audioUrl) {
        const audio = new Audio(audioUrl);
        audio.play();
    }

    // Обработка кнопки "Добавить в словарь"
    document.querySelectorAll('.add-to-dictionary').forEach(btn => {
        btn.addEventListener('click', function() {
            const cardId = this.getAttribute('data-card-id');
            addToDictionary(cardId);
        });
    });

    function addToDictionary(cardId) {
        // Отправить AJAX запрос на добавление в словарь
        fetch(`/api/dictionary/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ card_id: cardId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Карточка добавлена в словарь', 'success');
            } else {
                showNotification(data.message || 'Ошибка при добавлении', 'danger');
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showNotification('Ошибка соединения', 'danger');
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }
</script>
{% endblock %}